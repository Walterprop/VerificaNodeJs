<!DOCTYPE html>
<html>
<head>
    <title>Todo App</title>
</head>
<body>
    <h1>Todo App</h1>
    <p>Utente: <span id="username"></span> <button onclick="logout()">Logout</button></p>
    
    <h2>Aggiungi Task</h2>
    <form id="taskForm">
        <input type="text" id="title" placeholder="Titolo" required>
        <textarea id="description" placeholder="Descrizione"></textarea>
        <button type="submit">Aggiungi</button>
    </form>
    
    <h2>Le Tue Task</h2>
    <div>
        <button onclick="showAll()">Tutte</button>
        <button onclick="showPending()">In Sospeso</button>
        <button onclick="showCompleted()">Completate</button>
    </div>
    
    <div id="tasks"></div>
    <div id="message"></div>

    <script>
        let tasks = [];
        let filter = 'all';
        let authToken = localStorage.getItem('authToken');
        
        // Controllo autenticazione
        if (!authToken) {
            window.location.href = '/login';
        }
        
        // Mostra username
        const userData = localStorage.getItem('userData');
        if (userData) {
            const user = JSON.parse(userData);
            document.getElementById('username').textContent = user.username;
        }
        
        // Carica task all'avvio
        loadTasks();
        
        // Form per aggiungere task
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            
            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ title, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('taskForm').reset();
                    loadTasks();
                } else {
                    document.getElementById('message').textContent = data.message;
                }
            } catch (error) {
                document.getElementById('message').textContent = 'Errore di connessione';
            }
        });
        
        // Carica task
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    tasks = data.data;
                    renderTasks();
                }
            } catch (error) {
                console.error(error);
            }
        }
        
        // Renderizza task
        function renderTasks() {
            const container = document.getElementById('tasks');
            const filteredTasks = tasks.filter(task => {
                if (filter === 'all') return true;
                return task.status === filter;
            });
            
            container.innerHTML = filteredTasks.map(task => `
                <div style="border: 1px solid #ccc; margin: 10px; padding: 10px;">
                    <h3>${task.title}</h3>
                    <p>${task.description || ''}</p>
                    <p>Status: ${task.status}</p>
                    <button onclick="toggleTask('${task._id}')">
                        ${task.status === 'completed' ? 'Segna come in sospeso' : 'Completa'}
                    </button>
                    <button onclick="deleteTask('${task._id}')">Elimina</button>
                </div>
            `).join('');
        }
        
        // Toggle task status
        async function toggleTask(id) {
            const task = tasks.find(t => t._id === id);
            const newStatus = task.status === 'completed' ? 'pending' : 'completed';
            
            try {
                await fetch(`/api/tasks/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                loadTasks();
            } catch (error) {
                console.error(error);
            }
        }
        
        // Elimina task
        async function deleteTask(id) {
            if (confirm('Elimina questa task?')) {
                try {
                    await fetch(`/api/tasks/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    loadTasks();
                } catch (error) {
                    console.error(error);
                }
            }
        }
        
        // Filtri
        function showAll() { filter = 'all'; renderTasks(); }
        function showPending() { filter = 'pending'; renderTasks(); }
        function showCompleted() { filter = 'completed'; renderTasks(); }
        
        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }
    </script>
</body>
</html>